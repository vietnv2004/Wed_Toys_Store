@model Wed_Toys_Store.Models.DiscountCode

@{
    ViewData["Title"] = "Create Discount Code";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Admin Panel</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
    <style>
        .admin-main {
            margin-left: 250px;
        }
        
        .preview-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .preview-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body class="bg-body-secondary">
    @await Html.PartialAsync("_AdminSidebar")

    <!-- Main Content -->
    <div class="admin-main min-vh-100">
        <div class="container-fluid p-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">
                            <i class="bi bi-plus-circle me-2"></i>Create New Discount Code
                        </h2>
                        <a href="@Url.Action("Index", "DiscountCodes")" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Back to List
                        </a>
                    </div>

                    <form asp-action="Create" method="post">
                        @Html.AntiForgeryToken()
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <div class="row">
                            <!-- Form Fields -->
                            <div class="col-md-7">
                                <div class="mb-3">
                                    <label asp-for="Code" class="form-label fw-semibold">
                                        Discount Code <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="Code" 
                                           class="form-control form-control-lg text-uppercase" 
                                           placeholder="e.g., WELCOME10, NEWYEAR2026" 
                                           maxlength="20"
                                           id="codeInput"
                                           oninput="updatePreview(); updateCharCount()"
                                           required
                                           style="letter-spacing: 1px;">
                                    <div class="d-flex justify-content-between">
                                        <span asp-validation-for="Code" class="text-danger small"></span>
                                        <small class="text-muted">
                                            <span id="charCount">0</span>/20 characters
                                        </small>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="DiscountAmount" class="form-label fw-semibold">
                                            Discount Amount (VND) <span class="text-danger">*</span>
                                        </label>
                                        <input asp-for="DiscountAmount" 
                                               class="form-control form-control-lg" 
                                               type="text" 
                                               placeholder="50,000"
                                               id="discountAmount"
                                               oninput="formatCurrencyInput(this); updatePreview()"
                                               autocomplete="off"
                                               required>
                                        <small class="form-text text-muted">Enter amount in VND. Use digits only; commas will be added automatically.</small>
                                        <span asp-validation-for="DiscountAmount" class="text-danger small"></span>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label asp-for="MinOrderAmount" class="form-label fw-semibold">
                                            Minimum Order (VND) <span class="text-danger">*</span>
                                        </label>
                                        <input asp-for="MinOrderAmount" 
                                               class="form-control form-control-lg" 
                                               type="text" 
                                               placeholder="300,000"
                                               id="minOrder"
                                               oninput="formatCurrencyInput(this); updatePreview()"
                                               autocomplete="off"
                                               required>
                                        <small class="form-text text-muted">Minimum order value in VND. Use digits only; commas will be added automatically.</small>
                                        <span asp-validation-for="MinOrderAmount" class="text-danger small"></span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Description" class="form-label fw-semibold">Description</label>
                                    <textarea asp-for="Description" 
                                              class="form-control" 
                                              rows="3" 
                                              placeholder="e.g., Welcome discount for new customers"
                                              id="description"
                                              oninput="updatePreview()"></textarea>
                                    <span asp-validation-for="Description" class="text-danger small"></span>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="ExpiryDate" class="form-label fw-semibold">
                                            Expiry Date <span class="text-danger">*</span>
                                        </label>
                                        <input asp-for="ExpiryDate" 
                                               class="form-control form-control-lg" 
                                               type="datetime-local"
                                               id="expiryDate"
                                               oninput="updatePreview()"
                                               required>
                                        <span asp-validation-for="ExpiryDate" class="text-danger small"></span>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold">
                                            Max Uses
                                        </label>
                                        <input asp-for="MaxUsage"
                                               class="form-control form-control-lg"
                                               type="number"
                                               min="0"
                                               placeholder="0"
                                               value="0">
                                        <small class="form-text text-muted">0 = unlimited, otherwise number of times this code can be used.</small>
                                        <span asp-validation-for="MaxUsage" class="text-danger small"></span>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold">Status</label>
                                        <div class="form-check form-switch mt-2">
                                            <input asp-for="IsActive" 
                                                   class="form-check-input" 
                                                   type="checkbox" 
                                                   role="switch"
                                                   checked>
                                            <label class="form-check-label ms-2" asp-for="IsActive">
                                                Active (code can be used immediately)
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex gap-3 mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg px-5">
                                        <i class="bi bi-check-circle me-2"></i>Create Discount Code
                                    </button>
                                    <a href="@Url.Action("Index", "DiscountCodes")" class="btn btn-outline-secondary btn-lg px-4">
                                        <i class="bi bi-x-circle me-2"></i>Cancel
                                    </a>
                                </div>
                            </div>

                            <!-- Live Preview -->
                            <div class="col-md-5">
                                <div class="sticky-top" style="top: 20px;">
                                    <h5 class="fw-bold mb-3">
                                        <i class="bi bi-eye me-2"></i>Live Preview
                                    </h5>
                                    <div class="preview-card p-3">
                                        <div class="row g-0">
                                            <div class="col-auto">
                                                <div class="preview-icon">
                                                    <i class="bi bi-ticket-perforated"></i>
                                                </div>
                                            </div>
                                            <div class="col ps-3">
                                                <div class="d-flex justify-content-between align-items-start h-100">
                                                    <div class="flex-grow-1">
                                                        <div class="fw-semibold mb-1">
                                                            <span class="badge bg-primary me-2" id="previewCode">CODE</span>
                                                            Discount <span id="previewAmount">0</span>₫
                                                        </div>
                                                        <div class="text-muted small mb-1">
                                                            <i class="bi bi-calendar3 me-1"></i>
                                                            Valid until <span id="previewExpiry">--</span>
                                                        </div>
                                                        <div class="text-muted small">
                                                            <i class="bi bi-cart-check me-1"></i>
                                                            Min order: <span id="previewMinOrder">0</span>₫
                                                        </div>
                                                        <div class="text-muted small mt-2" id="previewDesc" style="display: none;">
                                                            
                                                        </div>
                                                    </div>
                                                    <div class="text-end ms-3">
                                                        <button type="button" class="btn btn-sm btn-outline-primary" disabled>
                                                            Use Now
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-info mt-3 small">
                                        <i class="bi bi-info-circle me-2"></i>
                                        This is how your discount code will appear to users
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Allow numbers with thousand separators in jQuery validation
        if (window.jQuery && $.validator && $.validator.methods && $.validator.methods.number) {
            const originalNumberMethod = $.validator.methods.number;
            $.validator.methods.number = function (value, element) {
                if (typeof value === 'string') {
                    value = value.replace(/,/g, '');
                }
                return originalNumberMethod.call(this, value, element);
            };
        }

        // Format input as VND with thousand separators while typing
        function formatCurrencyInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (!value) {
                input.value = '';
                return;
            }
            input.value = parseInt(value, 10).toLocaleString('en-US');
        }

        // Set default expiry date to 30 days from now
        document.addEventListener('DOMContentLoaded', function() {
            const expiryInput = document.getElementById('expiryDate');
            const now = new Date();
            now.setDate(now.getDate() + 30); // 30 days from now
            const dateString = now.toISOString().slice(0, 16);
            expiryInput.value = dateString;
            
            updateCharCount();
            updatePreview();

            // If there are existing values (after validation error), normalize their format
            ['discountAmount', 'minOrder'].forEach(id => {
                const el = document.getElementById(id);
                if (el && el.value) {
                    formatCurrencyInput(el);
                }
            });

            // Before submit, strip separators so server receives raw numbers
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function () {
                    ['discountAmount', 'minOrder'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el && el.value) {
                            el.value = el.value.replace(/\D/g, '');
                        }
                    });
                });
            }
        });
        
        function updateCharCount() {
            const input = document.getElementById('codeInput');
            const charCount = document.getElementById('charCount');
            const currentLength = input.value.length;
            charCount.textContent = currentLength;
            
            // 20-character hard limit
            if (currentLength >= 15 && currentLength < 20) {
                charCount.classList.add('text-warning');
                charCount.classList.remove('text-danger');
            } else if (currentLength === 20) {
                charCount.classList.remove('text-warning');
                charCount.classList.add('text-danger');
            } else {
                charCount.classList.remove('text-warning');
                charCount.classList.remove('text-danger');
            }
        }
        
        function updatePreview() {
            // Update code
            const code = document.getElementById('codeInput').value || 'CODE';
            document.getElementById('previewCode').textContent = code.toUpperCase();
            
            // Update discount amount - remove commas before parsing
            const amount = document.getElementById('discountAmount').value.replace(/,/g, '') || '0';
            document.getElementById('previewAmount').textContent = parseFloat(amount).toLocaleString('en-US');
            
            // Update min order - remove commas before parsing
            const minOrder = document.getElementById('minOrder').value.replace(/,/g, '') || '0';
            document.getElementById('previewMinOrder').textContent = parseFloat(minOrder).toLocaleString('en-US');
            
            // Update expiry date
            const expiry = document.getElementById('expiryDate').value;
            if (expiry) {
                const date = new Date(expiry);
                const options = { day: '2-digit', month: 'short', year: 'numeric' };
                document.getElementById('previewExpiry').textContent = date.toLocaleDateString('en-US', options);
            } else {
                document.getElementById('previewExpiry').textContent = '--';
            }
            
            // Update description
            const desc = document.getElementById('description').value;
            const previewDesc = document.getElementById('previewDesc');
            if (desc) {
                previewDesc.textContent = desc;
                previewDesc.style.display = 'block';
            } else {
                previewDesc.style.display = 'none';
            }
        }
        
        // Auto-uppercase the code input
        document.getElementById('codeInput').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    </script>
</body>
</html>


